<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Controle de Gastos - Simples</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="mask-icon" href="icons/icon-192.png" color="#0f172a">
  
</head>
<body>
  <header class="topbar">
    <div class="brand" style="letter-spacing: 2px; text-align: center; margin-left: px; padding-top: 4px; padding-bottom: 4px; color: black;">CONTROLE FINANCEIRO</div>

    <nav class="nav">
      <div class="nav-item-wrap">
        <a id="nav-dashboard" class="nav-item active" onclick="navTo('dashboard')">
          <span class="nav-icon" aria-hidden="true"><img class="nav-img" src="https://img.icons8.com/3d-fluency/48/home.png" onerror="this.onerror=null;this.src='https://img.icons8.com/color/48/home.png'" alt="Home"/></span>
        </a>
        <div class="nav-label">Home</div>
      </div>
      <div class="nav-item-wrap">
        <a id="nav-transactions" class="nav-item" onclick="navTo('transactions')">
          <span class="nav-icon" aria-hidden="true"><img class="nav-img" src="https://img.icons8.com/?size=100&id=JQX2fDPyQq4E&format=png&color=000000" alt="Transa√ß√µes"/></span>
        </a>
        <div class="nav-label">Transa√ß√µes</div>
      </div>
      <div class="nav-item-wrap">
        <a id="nav-reports" class="nav-item" onclick="navTo('reports')">
          <span class="nav-icon" aria-hidden="true"><img class="nav-img" src="https://img.icons8.com/?size=100&id=QaM8Y9VT9Fzp&format=png&color=000000" alt="Relat√≥rios"/></span>
        </a>
        <div class="nav-label">Relat√≥rios</div>
      </div>
    <!-- Extra/settings nav removed per user request -->
    </nav>
    <div class="saldo">Saldo Atual<br><span class="saldo-val">R$ <span id="saldo">0,00</span></span></div>
    <button id="btn-install" class="btn install hidden" aria-hidden="true" title="Instalar aplica√ß√£o">üì≤ Instalar</button>
  </header>

  <main>
    <div id="section-dashboard" class="container section">
    <section class="header-row">
      <div class="title-wrap">
        <h1>Home</h1>
        <p class="subtitle"></p>
        <div class="controls-center">
          <div class="btn-group">
            <button id="add-income" class="btn primary" onclick="openModal('income')">
              <span class="btn-plus">+</span>
            </button>
            <span class="btn-label">Renda</span>
          </div>
          <!-- Money bag icon between buttons -->
          <div class="btn-icon-wrap" aria-hidden="true">
            <img class="money-bag-icon" src="https://img.icons8.com/3d-fluency/48/money-bag.png" onerror="this.onerror=null;this.src='https://img.icons8.com/color/48/money-bag.png'" alt="Money bag" />
          </div>
          <div class="btn-group">
            <button id="add-expense" class="btn" onclick="openModal('expense')">
              <span class="btn-plus">+</span>
            </button>
            <span class="btn-label">Gastos</span>
          </div>
        </div>
        
      </div>
    </section>

    <section class="cards">
      <div class="card credit-card credit-bg">
        <div class="credit-overlay">
            <!-- stat boxes removed per user request; card shows only background and chip -->
            <!-- Renda Total (overlay text only, no background) -->
            <div class="stat-box small top-left" aria-hidden="false">
              <div class="stat-title">Renda Total</div>
              <div class="stat-amount" id="credit-renda">R$ 0,00</div>
            </div>

            <!-- Gastos Totais (top-right) - same typography as Renda Total -->
            <div class="stat-box medium top-right" aria-hidden="false">
              <div class="stat-title">Gastos Totais</div>
              <div class="stat-amount danger" id="credit-gastos">R$ 0,00</div>
              <div class="stat-sub" id="credit-tx-count">0 transa√ß√µes</div>
            </div>

            <!-- Saldo Atual (moved below Renda Total) -->
            <div class="stat-box small mid-left" aria-hidden="false">
              <div class="stat-title">Saldo Atual</div>
              <div class="stat-amount" id="credit-saldo">R$ 0,00</div>
            </div>

            <!-- Taxa de Economia (bottom-right) -->
            <div class="credit-taxa">
              <div class="stat-title">Taxa de Economia</div>
              <div id="credit-taxa" class="stat-amount">0.0%</div>
            </div>

            <!-- chip image like in the mock -->
            <img class="card-chip" src="cartao.png" alt="chip" style="width:clamp(450px,58%,260px);left:50%;transform:translateX(-50%);position:absolute;top:-19px;max-width:350px; border-radius: 29px; height: 250px;" onerror="this.onerror=null;this.src='https://img.icons8.com/color/80/smart-card-chip.png'" />

            <!-- Gastos do M√™s removed per user request -->

            <!-- card meta removed per user request -->
            <!-- optional PNG below the card stats (replace src with your image) -->
            <img id="card-extra-png" class="card-extra-png" src="img/card-extra.png" alt="extra graphic" onerror="this.onerror=null;this.style.display='none'" />
            <!-- compact transactions removed per request -->
          </div>
      </div>
      <!-- Upcoming card removed per user request -->
    </section>

    <section class="month-summary">
      <div class="box tips">
        <h3>Desempenho do M√™s</h3>
        <div class="star-meter" id="month-star-meter" aria-hidden="false">
          <!-- stars will be filled by JS -->
          <span class="star" data-index="1">‚òÖ</span>
          <span class="star" data-index="2">‚òÖ</span>
          <span class="star" data-index="3">‚òÖ</span>
          <span class="star" data-index="4">‚òÖ</span>
          <span class="star" data-index="5">‚òÖ</span>
          <span class="star-pct" id="month-star-pct">0%</span>
        </div>
        <div class="tip small muted" id="month-star-msg"></div>
      </div>
    </section>

    <section class="recent">
      <h3 class="centered-heading">Transa√ß√µes Recentes</h3>
      <div class="recent-box" id="recent-box">
        <div class="empty">Nenhuma transa√ß√£o encontrada<br><small>Adicione sua primeira renda ou gasto para come√ßar</small></div>
      </div>
    </section>
    </div>

    <div id="section-transactions" class="container section hidden">
      <section class="header-row">
        <h1>Transa√ß√µes</h1>
        <p class="subtitle">Lista completa das suas transa√ß√µes</p>
      </section>
      <section class="recent">
        <h3>Todas as Transa√ß√µes</h3>
        <div class="recent-box" id="all-transactions-box">
          <div class="empty">Nenhuma transa√ß√£o registrada</div>
        </div>
      </section>
    </div>

    <div id="section-reports" class="container section hidden">
      <section class="header-row">
        <h1>Relat√≥rios</h1>
        <p class="subtitle">Gr√°ficos e resumos</p>
      </section>
      <section class="box">
        <h3>Renda vs Gastos (Total)</h3>
  <div class="report-controls">
          <label>De: <input type="date" id="report-start"></label>
          <label>At√©: <input type="date" id="report-end"></label>
          <button class="btn" id="report-filter">Filtrar</button>
          <button class="btn" id="report-clear">Limpar</button>
        </div>
        <div class="chart-wrap">
          <canvas id="chart-income-expense" width="240" height="240"></canvas>
        </div>
  <div id="report-legend" class="report-legend"></div>
      </section>
      <section class="box">
        <h3>Gastos por Categoria</h3>
        <div class="chart-wrap">
          <canvas id="chart-by-category" width="340" height="220"></canvas>
        </div>
        <div id="report-legend-cats" class="report-legend"></div>
      </section>
    </div>

    <!-- Settings section removed per user request -->
  </main>

  <!-- modal -->
  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Adicionar</h3>
        <button class="modal-close" aria-label="Fechar" onclick="closeModal()">‚úï</button>
      </div>
      <form id="tx-form" onsubmit="addTx(event)">
        <div class="form-row">
          <label>Tipo
            <select id="tx-type">
              <option value="income">Renda</option>
              <option value="expense">Gasto</option>
            </select>
          </label>
        </div>
        <input type="hidden" id="tx-id" />
        <div class="form-row">
          <label>Descri√ß√£o
            <input id="tx-desc" required placeholder="Ex: Sal√°rio, Mercado, Uber">
          </label>
        </div>
        <div class="form-row">
          <label>Valor
            <input id="tx-value" type="number" step="0.01" required placeholder="0.00">
          </label>
        </div>
        <div class="form-row">
          <label>Parcelas (total)
            <input id="tx-installments-total" type="number" min="1" placeholder="1">
          </label>
        </div>
        <div class="form-row">
          <label>Vencimento
            <input id="tx-due-date" type="date" placeholder="">
          </label>
        </div>
        <div class="form-row">
          <label>Parcelas pagas
            <input id="tx-installments-paid" type="number" min="0" placeholder="0">
          </label>
        </div>
        <div class="form-row">
          <label>Valor da parcela
            <input id="tx-per-installment" type="number" step="0.01" placeholder="0.00">
          </label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Salvar</button>
          <button type="button" id="cancel" class="btn" onclick="closeModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const KEY = 'simple_dashboard_tx';
      function $(s){return document.querySelector(s)}
      const recentBox = $('#recent-box');
      const saldoEl = $('#saldo');
      const cardSaldo = $('#card-saldo');
      const cardRenda = $('#card-renda');
      const cardGastos = $('#card-gastos');
      const cardTaxa = $('#card-taxa');
      const monthGastos = $('#month-gastos');
      const monthTx = $('#month-transacoes');
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
  const txType = document.getElementById('tx-type');
  const txDesc = document.getElementById('tx-desc');
  const txValue = document.getElementById('tx-value');
  const txInstallmentsTotal = document.getElementById('tx-installments-total');
  const txInstallmentsPaid = document.getElementById('tx-installments-paid');
  const txPerInstallment = document.getElementById('tx-per-installment');
  const txDueDate = document.getElementById('tx-due-date');
  const txId = document.getElementById('tx-id');

      let txs = [];

      function categorize(desc, type){
        const s = (desc||'').toLowerCase();
        if(type === 'income'){
          if(/sal[a√°]r/i.test(s) || s.includes('salario') || s.includes('sal√°rio')) return 'Sal√°rio';
          if(s.includes('freel') || s.includes('freela') || s.includes('projeto')) return 'Freelance';
          return 'Outros';
        }
          if(s.match(/cart(√£|a)o|cartao|fatura|faturas|nubank|itau|bradesco|santander|caixa|banco|visa|mastercard|elo|amex/)) return 'Cart√£o';
        if(s.match(/supermercad|mercad|mercearia|padaria/)) return 'Alimenta√ß√£o';
        if(s.match(/restaurante|lanchonete|bar|delivery|pizza|burger/)) return 'Alimenta√ß√£o';
  if(s.match(/uber|taxi|√¥nibus|onibus|metr[o√≥]|transporte|combust(√≠|i)vel|gasolina|carro|moto|motocicleta|bicicleta|financi/)) return 'Transporte';
  if(s.match(/aluguel|condom[inio]/)) return 'Moradia';
  // utilities and household expenses -> Casa
  if(s.match(/luz|energia|agua|√°gua|internet|iptu/)) return 'Casa';
        if(s.match(/farmacia|rem[e√©]dio|doutor|hospital|cl[i√≠]nica/)) return 'Sa√∫de';
        if(s.match(/cinema|netflix|spotify|ingresso|teatro|jogo|bar/)) return 'Lazer';
        if(s.match(/curso|escola|facul|faculdade|livro/)) return 'Educa√ß√£o';
        if(s.match(/roupa|vestu[r√∫]ario|zapatos|sapato/)) return 'Vestu√°rio';
        if(s.match(/compra|loja|shopping|amazon|mercado livre|mercadolivre/)) return 'Compras';
        return 'Outros';
      }

      function categoryIcon(category){
        const c = (category||'').toLowerCase();
        // add onerror fallback to color icons if 3D assets are blocked / 404
        if(/sal[a√°]rio|salario|sal√°rio/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/money-bag.png" onerror="this.onerror=null;this.src='https://img.icons8.com/color/48/money-bag.png'" alt="Sal√°rio"/>`;
          if(/casa|moradia/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/home.png" onerror="this.onerror=null;this.src='https://img.icons8.com/color/48/home.png'" alt="Casa"/>`;
  if(/cart(√£|a)o|cartao|fatura|faturas|nubank|itau|bradesco|santander|caixa|banco|visa|mastercard|elo|amex/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/?size=100&id=5s14FYPGstpM&format=png&color=000000" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23111\'><rect x=\'1\' y=\'5\' width=\'22\' height=\'14\' rx=\'2\'/><rect x=\'3\' y=\'8\' width=\'6\' height=\'2\' fill=\'%23fff\'/><rect x=\'3\' y=\'12\' width=\'8\' height=\'2\' fill=\'%23fff\'/></svg>'" alt="Cart√£o"/>`;
          if(/uber|taxi|√¥nibus|onibus|metr[o√≥]|transporte|combust|gasolina|carro|moto|motocicleta|bicicleta|financi/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/car.png" onerror="this.onerror=null;this.src='https://img.icons8.com/color/48/car.png'" alt="Transporte"/>`;
          if(/alimenta√ß√£o|mercad|restaurante|padaria|delivery|pizza|burger/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/food.png" alt="Alimenta√ß√£o"/>`;
          if(/compras|compra|loja|shopping|amazon|mercado livre|mercadolivre/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/shopping-bag.png" alt="Compras"/>`;
          if(/sa√∫de|farmacia|rem[e√©]dio|hospital|cl[i√≠]nica/.test(c)) return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/health-book.png" alt="Sa√∫de"/>`;
          return `<img class="cat-img" src="https://img.icons8.com/3d-fluency/48/info.png" alt="Outros"/>`;
      }

      function load(){
        try{ const r = localStorage.getItem(KEY); txs = r? JSON.parse(r): [] }catch(e){ txs = [] }
          // reclassify and normalize transactions
          txs = txs.map(function(orig){
            var hadDue = Object.prototype.hasOwnProperty.call(orig, 'dueDate') && !!orig.dueDate;
            var t = Object.assign({}, orig);
            t.category = categorize(t.desc||'', t.type);
            t.installmentsTotal = t.installmentsTotal||undefined;
            t.installmentsPaid = t.installmentsPaid||0;
            t.perInstallment = t.perInstallment||undefined;
            t.dueDate = hadDue ? orig.dueDate : undefined;
            t._dueDateExplicit = (orig._dueDateExplicit === true) || hadDue;
            return t;
          });
          // Automatic migration: convert legacy `date` -> ISO dueDate and mark explicit so they show up
          try{
            var migrated = 0;
            txs = txs.map(function(t){
                if(!t._dueDateExplicit && !t._migratedFromDate && t.date && !t.dueDate){
                  var parts = (t.date||'').split('/');
                  if(parts.length===3){
                    t.dueDate = parts[2]+'-'+parts[1].padStart(2,'0')+'-'+parts[0].padStart(2,'0');
                    // mark migrated so we don't reapply this conversion repeatedly
                    t._migratedFromDate = true;
                    // do not set t._dueDateExplicit here
                    migrated++;
                  }
                }
              return t;
            });
            if(migrated>0) console.info('Migrated '+migrated+' transactions: converted legacy date -> dueDate (kept non-explicit)');
          }catch(e){console.error(e)}
          // Sanitize legacy-converted dueDates: if the dueDate equals the simple
          // conversion from the old `date` and the user did not explicitly set
          // a due date, remove it so the item won't appear in Upcoming.
          try{
            txs = txs.map(function(t){
              try{
                if(t.dueDate && !t._dueDateExplicit && t.date){
                  var p = (t.date||'').split('/');
                  if(p.length===3){
                    var conv = p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0');
                    if(conv === t.dueDate){ delete t.dueDate; t._migratedFromDate = true; }
                  }
                }
              }catch(e){}
              return t;
            });
          }catch(e){console.error(e)}
  try{ localStorage.setItem(KEY, JSON.stringify(txs)) }catch(e){}
        render();
      }
      function save(){ try{ localStorage.setItem(KEY, JSON.stringify(txs)) }catch(e){} }
      function formatMoney(v){ return Number(v).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}) }
      function calc(){
        const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.value,0);
        const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.value,0);
        const saldo = income - expense;
        const taxa = income===0?0: Math.round(((income-expense)/income)*1000)/10;
        return {income, expense, saldo, taxa}
      }

      function render(){
        const {income, expense, saldo, taxa} = calc();
        if(saldoEl) saldoEl.textContent = formatMoney(saldo);
  if(cardSaldo) cardSaldo.textContent = `R$ ${formatMoney(saldo)}`;
  if(cardRenda) cardRenda.textContent = `R$ ${formatMoney(income)}`;
  if(cardGastos) cardGastos.textContent = `R$ ${formatMoney(expense)}`;
  if(cardTaxa) cardTaxa.textContent = `${taxa.toFixed(1)}%`;
  // mirror values into the credit-card widget
  const creditSaldo = document.getElementById('credit-saldo');
  const creditRenda = document.getElementById('credit-renda');
  const creditGastos = document.getElementById('credit-gastos');
  const creditTaxa = document.getElementById('credit-taxa');
  if(creditSaldo) creditSaldo.textContent = `R$ ${formatMoney(saldo)}`;
  if(creditRenda) creditRenda.textContent = `R$ ${formatMoney(income)}`;
  if(creditGastos) creditGastos.textContent = `R$ ${formatMoney(expense)}`;
  if(creditTaxa) creditTaxa.textContent = `${taxa.toFixed(1)}%`;
  // transactions count on the card (localized singular/plural)
  const creditTxCountEl = document.getElementById('credit-tx-count');
  if(creditTxCountEl) creditTxCountEl.innerHTML = `Transa√ß√µes <span class="tx-num">${txs.length}</span>`;
  // populate the right-hand summary on the card
  const ccMonthGastos = document.getElementById('cc-month-gastos');
  const ccMonthTx = document.getElementById('cc-month-transacoes');
  if(ccMonthGastos) ccMonthGastos.textContent = `R$ ${formatMoney(expense)}`;
  if(ccMonthTx) ccMonthTx.textContent = `${txs.length}`;
  if(monthGastos) monthGastos.textContent = `R$ ${formatMoney(expense)}`;
  if(monthTx) monthTx.textContent = `${txs.length}`;

  // update month star meter (5 stars) and keep it in sync with the card Taxa de Economia
  try{
    const starPctEl = document.getElementById('month-star-pct');
    const starMsgEl = document.getElementById('month-star-msg');
    const starEls = Array.from(document.querySelectorAll('#month-star-meter .star'));
    if(starEls && starEls.length){
      // Use the same 'taxa' value computed by calc() so the star meter
      // matches the Taxa de Economia shown on the credit-card widget.
      const pct = (typeof taxa === 'number' && isFinite(taxa)) ? Math.max(0, Math.min(100, taxa)) : 0;
      if(starPctEl) starPctEl.textContent = `${pct.toFixed(1)}%`;
      const filledStars = Math.round((pct / 100) * 5);
      starEls.forEach((el, idx)=>{ if(idx < filledStars) el.classList.add('filled'); else el.classList.remove('filled'); });
  // Keep the existing static helper text; do not overwrite it with the verbose label
  // if(starMsgEl) starMsgEl.textContent = `Taxa de Economia (m√™s): ${pct.toFixed(1)}% da renda`;
    }
  }catch(e){console.error(e)}

  /* compact card transactions removed per request - no DOM updates here */

        recentBox.innerHTML = '';
        if(txs.length===0){
          recentBox.innerHTML = `<div class="empty">Nenhuma transa√ß√£o encontrada<br><small>Adicione sua primeira renda ou gasto para come√ßar</small></div>`;
          return;
        }

          txs.slice().reverse().forEach(t=>{
            const div = document.createElement('div');
            div.className = 'tx';
            // build multi-line meta for recent card
            let installmentInfo = '';
            // Only build installment info for expenses
            if(t.type === 'expense'){
              const hasInst = t.installmentsTotal !== undefined && t.installmentsTotal !== null && t.installmentsTotal !== '';
              if(!hasInst){
                installmentInfo = `
                  <div class="meta">Parcelas: 0/0</div>
                  <div class="meta">Pagas: 0</div>
                  <div class="meta">Faltam: 0</div>
                  <div class="meta">Total a pagar: R$ ${formatMoney(t.value)}</div>
                `;
              } else {
                const paid = Number(t.installmentsPaid || 0);
                const totalInst = Number(t.installmentsTotal || 0);
                const left = Math.max(0, totalInst - paid);
                const per = Number((t.perInstallment !== undefined && t.perInstallment !== null && t.perInstallment !== '') ? t.perInstallment : (t.value / totalInst));
                const parcelasLine = `${paid}/${totalInst}`;
                installmentInfo = `
                  <div class="meta">Parcelas: ${parcelasLine}</div>
                  <div class="meta">Pagas: ${paid}</div>
                  <div class="meta">Faltam: ${left}</div>
                  <div class="meta">Total a pagar: R$ ${formatMoney(per * left)}</div>
                `;
              }
            }
      const dueLabel = t.dueDate ? (function(){ var p = (t.dueDate||'').split('-'); if(p.length===3) return p[2]+'/'+p[1]+'/'+p[0]; return t.dueDate; })() : '';
      const dateLine = t.date ? `<div class="meta">Data: ${t.date}</div>` : (dueLabel ? `<div class="meta">Data: ${dueLabel}</div>` : `<div class="meta">Data: ‚Äî</div>`);
      const singleMeta = (t.type === 'expense') ? `
        <div class="meta">Parcelas: 1/1</div>
        <div class="meta">Pagas: ${t.installmentsPaid || 0}</div>
        <div class="meta">Faltam: ${Math.max(0, 1 - (t.installmentsPaid || 0))}</div>
        <div class="meta total">Total a pagar: R$ ${formatMoney(t.value)}</div>
      ` : '';
            div.innerHTML = `
              <div>
                <div class="cat-inline">${categoryIcon(t.category)} <strong class="cat-name">${t.category || '‚Äî'}</strong></div>
                <strong>${t.desc}</strong>
                ${dateLine}
                ${dueLabel ? `<div class="meta">Venc.: ${dueLabel}</div>` : ''}
                ${installmentInfo || singleMeta}
              </div>
              <div style="text-align:right">
                <div style="color:${t.type==='expense'? 'var(--danger)':'var(--accent)'}">R$ ${formatMoney(t.value)}</div>
                <div class="tx-actions">
                  <button class="btn" title="Editar" onclick="editTx('${t.id}')">‚úèÔ∏è</button>
                  <button class="btn" title="Remover" onclick="removeTx('${t.id}')">üóëÔ∏è</button>
                </div>
              </div>
            `;
            recentBox.appendChild(div);
          });
        // keep the all-transactions view in sync
        if(typeof renderAllTransactions === 'function') renderAllTransactions();
        // update reports if visible
        try{
          const reportsEl = document.getElementById('section-reports');
          if(reportsEl && !reportsEl.classList.contains('hidden') && typeof renderReports === 'function') renderReports();
        }catch(e){}
      }

      function openModal(type){
        modal.classList.remove('hidden');
        modalTitle.textContent = type==='income'? 'Adicionar Renda':'Adicionar Gasto';
        txType.value = type;
        // if editing (tx-id present), don't clear fields so editTx can prefill them
        const existingId = txId ? txId.value : '';
        if(!existingId){
          txDesc.value=''; txValue.value=''; txId.value='';
          if(txInstallmentsTotal) txInstallmentsTotal.value = '';
          if(txInstallmentsPaid) txInstallmentsPaid.value = '';
          if(txPerInstallment) txPerInstallment.value = '';
          if(txDueDate) txDueDate.value = '';
        }
      }
      function closeModal(){ modal.classList.add('hidden'); if(txId) txId.value=''; }

      function addTx(e){
        e.preventDefault();
        const t = txType.value;
        const desc = txDesc.value.trim();
        const value = Number(txValue.value);
        const instTotal = txInstallmentsTotal ? Number(txInstallmentsTotal.value) || undefined : undefined;
        const instPaid = txInstallmentsPaid ? Number(txInstallmentsPaid.value) || 0 : 0;
        const perInst = txPerInstallment ? Number(txPerInstallment.value) || undefined : undefined;
        const due = txDueDate && txDueDate.value ? txDueDate.value : undefined;
        if(!desc || isNaN(value) || value<=0) return alert('Preencha descri√ß√£o e valor v√°lido');
        const existing = txId.value;
            if(existing){
          const idx = txs.findIndex(x=>x.id===existing);
          if(idx!==-1){
            txs[idx].desc = desc; txs[idx].value = value; txs[idx].type = t;
            txs[idx].installmentsTotal = instTotal; txs[idx].installmentsPaid = instPaid; txs[idx].perInstallment = perInst; 
                // If user cleared the due date, remove the property and mark as non-explicit
                if(due){
                  txs[idx].dueDate = due;
                  txs[idx]._dueDateExplicit = true;
                } else {
                  delete txs[idx].dueDate;
                  txs[idx]._dueDateExplicit = false;
                }
          }
        }else{
            const newTx = { id: Math.random().toString(36).slice(2,9), type: t, desc, value, date: new Date().toLocaleDateString(), category: categorize(desc, t), installmentsTotal: instTotal, installmentsPaid: instPaid, perInstallment: perInst, dueDate: due };
            // mark whether the user explicitly set a due date for filtering
            newTx._dueDateExplicit = !!due;
            // if user did not set a due date we also mark that we didn't migrate it from old `date`
            if(!due) newTx._migratedFromDate = false;
            txs.push(newTx);
        }
        save(); render(); closeModal();
      }

      function removeTx(id){ txs = txs.filter(t=>t.id!==id); save(); render(); }
      function editTx(id){
        const tx = txs.find(t=>t.id===id);
        if(!tx) return;
        txId.value = tx.id;
        txType.value = tx.type;
        txDesc.value = tx.desc;
        txValue.value = String(tx.value);
        if(txInstallmentsTotal) txInstallmentsTotal.value = tx.installmentsTotal ? String(tx.installmentsTotal) : '';
        if(txInstallmentsPaid) txInstallmentsPaid.value = tx.installmentsPaid ? String(tx.installmentsPaid) : '';
        if(txPerInstallment) txPerInstallment.value = tx.perInstallment ? String(tx.perInstallment) : '';
        if(txDueDate) txDueDate.value = tx.dueDate ? tx.dueDate : '';
        openModal(tx.type);
      }

      // expose globally for inline handlers
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.addTx = addTx;
      window.removeTx = removeTx;
      window.editTx = editTx;

      function navTo(name){
        const sections = ['dashboard','transactions','reports','settings'];
        sections.forEach(s=>{
          const el = document.getElementById('section-'+s);
          const nav = document.getElementById('nav-'+s);
          if(el) el.classList.add('hidden');
          if(nav) nav.classList.remove('active');
        });
        const target = document.getElementById('section-'+name);
        const navTarget = document.getElementById('nav-'+name);
        if(target) target.classList.remove('hidden');
        if(navTarget) navTarget.classList.add('active');
        // when navigating to transactions, populate the full list
        if(name==='transactions' && typeof renderAllTransactions === 'function') renderAllTransactions();
        // when navigating to reports, render charts
        if(name==='reports' && typeof renderReports === 'function') renderReports();
      }
      window.navTo = navTo;

      function renderAllTransactions(){
        const box = document.getElementById('all-transactions-box');
        if(!box) return;
        box.innerHTML = '';
        if(txs.length===0){ box.innerHTML = '<div class="empty">Nenhuma transa√ß√£o registrada</div>'; return }
        
          txs.slice().reverse().forEach(t=>{
            const row = document.createElement('div');
            row.className = 'tx';
            let installmentInfo = '';
            // If installmentsTotal is missing, show zeros as requested
            if(t.installmentsTotal === undefined || t.installmentsTotal === null || t.installmentsTotal === ''){
              installmentInfo = `
                <div class="meta">Parcelas: 0/0</div>
                <div class="meta">Pagas: 0</div>
                <div class="meta">Faltam: 0</div>
                <div class="meta">Total a pagar: R$ ${formatMoney(t.value)}</div>
              `;
            }
            else if(t.installmentsTotal && t.installmentsTotal>1){
              const paid = Number(t.installmentsPaid || 0);
              const totalInst = Number(t.installmentsTotal || 0);
              const left = Math.max(0, totalInst - paid);
              const per = Number((t.perInstallment !== undefined && t.perInstallment !== null && t.perInstallment !== '') ? t.perInstallment : (t.value / totalInst));
              const parcelasLine = `${paid}/${totalInst}`;
              installmentInfo = `
                <div class="meta">Parcelas: ${parcelasLine}</div>
                <div class="meta">Pagas: ${paid}</div>
                <div class="meta">Faltam: ${left}</div>
                <div class="meta">Total a pagar: R$ ${formatMoney(per * left)}</div>
              `;
            }
  const dueLabel = t.dueDate ? (function(){ var p = (t.dueDate||'').split('-'); if(p.length===3) return p[2]+'/'+p[1]+'/'+p[0]; return t.dueDate; })() : '';
  const dateLine = t.date ? `<div class="meta">Data: ${t.date}</div>` : '';
      const singleMeta = (t.type === 'expense') ? `
        <div class="meta">Parcelas: 1/1</div>
        <div class="meta">Pagas: ${t.installmentsPaid || 0}</div>
        <div class="meta">Faltam: ${Math.max(0, 1 - (t.installmentsPaid || 0))}</div>
        <div class="meta">Total a pagar: R$ ${formatMoney(t.value)}</div>
      ` : '';
            row.innerHTML = `
              <div>
                <div class="cat-inline">${categoryIcon(t.category)} <strong class="cat-name">${t.category || '‚Äî'}</strong></div>
                <strong>${t.desc}</strong>
                ${dateLine}
                ${t.type === 'expense' && dueLabel ? `<div class="meta">Venc.: ${dueLabel}</div>` : ''}
                ${t.type === 'expense' ? (installmentInfo || singleMeta) : ''}
              </div>
              <div style="text-align:right">
                <div style="color:${t.type==='expense'? 'var(--danger)':'var(--accent)'}">R$ ${formatMoney(t.value)}</div>
                <div class="tx-actions">
                  <button class="btn" title="Editar" onclick="editTx('${t.id}')">‚úèÔ∏è</button>
                  <button class="btn" title="Remover" onclick="removeTx('${t.id}')">üóëÔ∏è</button>
                </div>
              </div>
            `;
            box.appendChild(row);
          });
      }

      // helper: prefer dueDate (ISO) or fallback to tx.date (dd/mm/yyyy)
      function getStartDate(t){
        if(t.dueDate){ const p = (t.dueDate||'').split('-'); if(p.length===3) return new Date(Number(p[0]), Number(p[1])-1, Number(p[2])); }
        const parts = (t.date||'').split('/'); if(parts.length===3) return new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0]));
        return new Date();
      }

      // Upcoming-related inline helpers and UI removed per user request

      function renderReports(){
        const canvas = document.getElementById('chart-income-expense');
        if(!canvas) return;
          if(typeof Chart === 'undefined') return; // chart lib not loaded yet
        // optionally apply date filter (report-start, report-end in yyyy-mm-dd)
        const startEl = document.getElementById('report-start');
        const endEl = document.getElementById('report-end');
        const startDate = startEl && startEl.value ? new Date(startEl.value) : null;
        const endDate = endEl && endEl.value ? new Date(endEl.value) : null;
        // aggregate totals applying date filter
        let totalIncome = 0, totalExpense = 0;
        txs.forEach(t=>{
          // parse dd/mm/yyyy
          const parts = (t.date||'').split('/');
          let dt = new Date();
          if(parts.length===3){ dt = new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0])); }
          if(startDate && dt < startDate) return;
          if(endDate && dt > endDate) return;
          if(t.type==='income') totalIncome += t.value; else totalExpense += t.value;
        });
        if(!window._incomeExpenseChart){
          const ctx = canvas.getContext('2d');
          window._incomeExpenseChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Renda','Gastos'], datasets: [{ data: [totalIncome, totalExpense], backgroundColor: ['rgba(16,185,129,0.8)','rgba(239,68,68,0.8)'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } } });
        } else {
          const ch = window._incomeExpenseChart;
          ch.data.datasets[0].data = [totalIncome, totalExpense];
          ch.update();
        }
        // update legend text
        const legend = document.getElementById('report-legend');
        if(legend){
          const total = totalIncome + totalExpense;
          const pi = total===0?0: Math.round((totalIncome/total)*1000)/10;
          const pe = total===0?0: Math.round((totalExpense/total)*1000)/10;
          // render main legend lines as separate block items
          legend.innerHTML = `<div class="legend-item"><strong>Renda:</strong> R$ ${formatMoney(totalIncome)} (${pi}%)</div><div class="legend-item"><strong>Gastos:</strong> R$ ${formatMoney(totalExpense)} (${pe}%)</div>`;
        }
        // --- monthly consumption per category (line chart) ---
        try{
          const catCanvas = document.getElementById('chart-by-category');
          if(catCanvas){
            // aggregate expenses per category by month (YYYY-MM)
            const byMonthCat = {};
            const monthSet = new Set();
            txs.forEach(t=>{
              const parts = (t.date||'').split('/');
              let dt = new Date();
              if(parts.length===3){ dt = new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0])); }
              if(startDate && dt < startDate) return;
              if(endDate && dt > endDate) return;
              if(t.type!=='expense') return;
              const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
              monthSet.add(key);
              const cat = t.category || 'Outros';
              byMonthCat[key] = byMonthCat[key] || {};
              byMonthCat[key][cat] = (byMonthCat[key][cat]||0) + t.value;
            });
            const months = Array.from(monthSet).sort();
            const labels = months.map(m => { const [y,mo] = m.split('-'); return `${mo}/${y}`; });
            // compute totals per category to pick top categories
            const totalsPerCat = {};
            months.forEach(m=>{
              const cats = byMonthCat[m]||{};
              Object.keys(cats).forEach(c=> totalsPerCat[c] = (totalsPerCat[c]||0) + cats[c]);
            });
            const categories = Object.keys(totalsPerCat).sort((a,b)=>totalsPerCat[b]-totalsPerCat[a]).slice(0,6);
            const palette = ['#ef4444','#f97316','#16a34a','#0ea5e9','#7c3aed','#eab308','#06b6d4','#f43f5e'];
            const datasets = categories.map((cat,i)=>({ label:cat, data: months.map(m => (byMonthCat[m] && byMonthCat[m][cat])? byMonthCat[m][cat] : 0), borderColor: palette[i%palette.length], backgroundColor: palette[i%palette.length], fill:false, tension:0.25 }));
            if(!window._categoryChart){
              const ctx2 = catCanvas.getContext('2d');
              window._categoryChart = new Chart(ctx2, { type:'line', data:{ labels, datasets }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } } });
            } else {
              const ch2 = window._categoryChart;
              ch2.config.type = 'line';
              ch2.data.labels = labels;
              ch2.data.datasets = datasets;
              ch2.update();
            }
            const legendCats = document.getElementById('report-legend-cats');
            if(legendCats){
              let html = '';
              categories.forEach((c,i)=> html += `<div class="legend-item"><span class="legend-dot" style="background:${palette[i%palette.length]}"></span>${c}: R$ ${formatMoney(totalsPerCat[c]||0)}</div>`);
              legendCats.innerHTML = html;
            }
          }
        }catch(e){ console.error(e) }
      }

  load();
  // minimal inline due-soon computation and notify button for the inline script path
  try {
    const DUE_THRESHOLD_DAYS = 7;
    function computeDueSoonInline(thresholdDays) {
      const now = new Date();
      const limit = new Date(now.getFullYear(), now.getMonth(), now.getDate() + Number(thresholdDays));
      const set = new Set();
      txs.forEach(function (t) {
        try {
          if (!t.dueDate) return;
          const start = getStartDate(t);
          const total = t.installmentsTotal && Number(t.installmentsTotal) > 1 ? Number(t.installmentsTotal) : 1;
          const paid = Number(t.installmentsPaid || 0);
          if (paid >= total) return;
          const nextIdx = paid;
          const nextDue = new Date(start.getFullYear(), start.getMonth() + nextIdx, start.getDate());
          if (nextDue >= now && nextDue <= limit) set.add(t.id);
        }
        catch (e) { }
      });
      return set;
    }
    function ensureNotifyButtonInline() {
      try {
        var btn = document.getElementById('notify-btn');
        if (!btn) {
          var header = document.querySelector('.topbar');
          if (!header) return;
          btn = document.createElement('button');
          btn.id = 'notify-btn';
          btn.className = 'btn';
          btn.style.marginLeft = '8px';
          btn.textContent = 'Ativar notifica√ß√µes';
          btn.addEventListener('click', function () {
            // prefer the richer push activation flow if available
            if (typeof activatePushFlow === 'function') return activatePushFlow();
            if (!('Notification' in window)) return alert('Notifica√ß√µes n√£o s√£o suportadas neste navegador');
            try {
              Notification.requestPermission().then(function (perm) {
                if (perm === 'granted') {
                  var cnt = computeDueSoonInline(DUE_THRESHOLD_DAYS).size;
                  try { new Notification('Controle Finan√ßas', { body: 'H√° ' + cnt + ' vencimento(s) nos pr√≥ximos ' + DUE_THRESHOLD_DAYS + ' dias.' }); } catch (e) { }
                }
                else if (perm === 'denied') {
                  alert('Permiss√£o negada para notifica√ß√µes');
                }
              });
            }
            catch (e) { console.error(e); }
          });
          header.appendChild(btn);
        }
      }
      catch (e) { }
    }
    try { ensureNotifyButtonInline(); } catch (e) { }
  } catch (e) { }
  // Ensure upcoming notices and the on-page diagnostic are shown without
  // requiring the user to open DevTools. Also update the global render to
  // include upcoming and diagnostics so manual calls reflect both areas.
  window.render = function(){ render(); };
      // hook report filter buttons
      try{
        const btnFilter = document.getElementById('report-filter');
        const btnClear = document.getElementById('report-clear');
        if(btnFilter) btnFilter.addEventListener('click', (e)=>{ e.preventDefault(); renderReports(); navTo('reports'); });
        if(btnClear) btnClear.addEventListener('click', (e)=>{ e.preventDefault(); const s=document.getElementById('report-start'); const t=document.getElementById('report-end'); if(s) s.value=''; if(t) t.value=''; renderReports(); });
      }catch(e){}
    })();
  </script>
  <script src="app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Dev helper: if you open the page with ?debug_toast=1 it will simulate an incoming push
    try{
      if(location.search.indexOf('debug_toast=1')!==-1 && window.simulateIncomingPush){
        // craft a sample payload similar to push-server
        const sample = { title: 'Teste de Vencimento', body: 'Conta Demo vence dia 30/09/2025 Valor: R$ 120,00', data: { txId: 'demo_push_1', meta: 'Demo' } };
        setTimeout(()=>{ try{ window.simulateIncomingPush(sample); }catch(e){} }, 800);
      }
    }catch(e){}
  </script>
</body>
</html>